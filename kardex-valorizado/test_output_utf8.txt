============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.1, pluggy-1.6.0
rootdir: C:\Users\TUF\Documents\GitHub\kardex\kardex-valorizado
plugins: anyio-4.11.0
collected 2 items

tests\test_inventory_service.py FF                                       [100%]

================================== FAILURES ===================================
_________________________ test_get_stock_actual_empty _________________________

session = <sqlalchemy.orm.session.Session object at 0x000001E63DCA6F90>
sample_data = {'almacen': <models.database_model.Almacen object at 0x000001E63EFF8050>, 'categoria': <models.database_model.Categori...model.Empresa object at 0x000001E63DCA7230>, 'producto': <models.database_model.Producto object at 0x000001E63EFF86E0>}

    def test_get_stock_actual_empty(session, sample_data):
        """Test stock is 0 for new product"""
        service = InventoryService(session)
>       stock = service.get_stock_actual(sample_data["producto"].id, sample_data["almacen"].id)
                ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'InventoryService' object has no attribute 'get_stock_actual'

tests\test_inventory_service.py:8: AttributeError
________________________ test_get_valorization_report _________________________

self = <sqlalchemy.engine.base.Connection object at 0x000001E63D7EF100>
dialect = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x000001E63DCA6120>
constructor = <bound method DefaultExecutionContext._init_compiled of <class 'sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext'>>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x000001E63F054050>
parameters = [{'almacen_id': 1, 'cantidad_entrada': 10.0, 'cantidad_salida': 0.0, 'cliente_id': None, ...}, {'almacen_id': 1, 'cantidad_entrada': 5.0, 'cantidad_salida': 0.0, 'cliente_id': None, ...}]
execution_options = immutabledict({'compiled_cache': <sqlalchemy.util._collections.LRUCache object at 0x000001E63DE40C70>})
args = (<sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x000001E63F054050>, [{'almacen_id': 1, 'cantidad_entrada':...: 5.0, 'cantidad_salida': 0.0, 'cliente_id': None, ...}], <sqlalchemy.sql.dml.Insert object at 0x000001E63DD5DBF0>, [])
kw = {'cache_hit': <CacheStats.CACHE_MISS: 1>}, yp = None
conn = <sqlalchemy.pool.base._ConnectionFairy object at 0x000001E63D7E1790>

    def _execute_context(
        self,
        dialect: Dialect,
        constructor: Callable[..., ExecutionContext],
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
        execution_options: _ExecuteOptions,
        *args: Any,
        **kw: Any,
    ) -> CursorResult[Any]:
        """Create an :class:`.ExecutionContext` and execute, returning
        a :class:`_engine.CursorResult`."""
    
        if execution_options:
            yp = execution_options.get("yield_per", None)
            if yp:
                execution_options = execution_options.union(
                    {"stream_results": True, "max_row_buffer": yp}
                )
        try:
            conn = self._dbapi_connection
            if conn is None:
                conn = self._revalidate_connection()
    
>           context = constructor(
                dialect, self, conn, execution_options, *args, **kw
            )

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1815: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py:1493: in _init_compiled
    flattened_processors[key](compiled_params[key])
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

value = '2023-01-01'

    def process(value):
        if value is None:
            return None
        elif isinstance(value, datetime_date):
            return format_ % {
                "year": value.year,
                "month": value.month,
                "day": value.day,
            }
        else:
>           raise TypeError(
                "SQLite Date type only accepts Python "
                "date objects as input."
            )
E           TypeError: SQLite Date type only accepts Python date objects as input.

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1287: TypeError

The above exception was the direct cause of the following exception:

session = <sqlalchemy.orm.session.Session object at 0x000001E63DCA67B0>
sample_data = {'almacen': <models.database_model.Almacen object at 0x000001E63DD1FB10>, 'categoria': <models.database_model.Categori...model.Empresa object at 0x000001E63DD1F9D0>, 'producto': <models.database_model.Producto object at 0x000001E63DD1FD90>}

    def test_get_valorization_report(session, sample_data):
        """Test valorization report calculation"""
        service = InventoryService(session)
    
        # Create some movements
        # 1. Buy 10 units at 10.0
        mov1 = MovimientoStock(
            empresa_id=sample_data["empresa"].id,
            producto_id=sample_data["producto"].id,
            almacen_id=sample_data["almacen"].id,
            tipo=TipoMovimiento.COMPRA,
            fecha_documento="2023-01-01",
            cantidad_entrada=10.0,
            cantidad_salida=0.0,
            costo_unitario=10.0,
            costo_total=100.0,
            saldo_cantidad=10.0,
            saldo_costo_total=100.0
        )
        session.add(mov1)
    
        # 2. Buy 5 units at 20.0
        mov2 = MovimientoStock(
            empresa_id=sample_data["empresa"].id,
            producto_id=sample_data["producto"].id,
            almacen_id=sample_data["almacen"].id,
            tipo=TipoMovimiento.COMPRA,
            fecha_documento="2023-01-02",
            cantidad_entrada=5.0,
            cantidad_salida=0.0,
            costo_unitario=20.0,
            costo_total=100.0,
            saldo_cantidad=15.0,
            saldo_costo_total=200.0
        )
        session.add(mov2)
>       session.commit()

tests\test_inventory_service.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:1286: in _prepare_impl
    self.session.flush()
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:4331: in flush
    self._flush(objects)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:4427: in _flush
    flush_context.execute()
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:466: in execute
    rec.execute(self)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\persistence.py:93: in save_obj
    _emit_insert_statements(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\persistence.py:1143: in _emit_insert_statements
    result = connection.execute(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1821: in _execute_context
    self._handle_dbapi_exception(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1815: in _execute_context
    context = constructor(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py:1493: in _init_compiled
    flattened_processors[key](compiled_params[key])
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

value = '2023-01-01'

    def process(value):
        if value is None:
            return None
        elif isinstance(value, datetime_date):
            return format_ % {
                "year": value.year,
                "month": value.month,
                "day": value.day,
            }
        else:
>           raise TypeError(
                "SQLite Date type only accepts Python "
                "date objects as input."
            )
E           sqlalchemy.exc.StatementError: (builtins.TypeError) SQLite Date type only accepts Python date objects as input.
E           [SQL: INSERT INTO movimientos_stock (empresa_id, producto_id, almacen_id, tipo, tipo_documento, numero_documento, fecha_documento, proveedor_id, cliente_id, destino_id, motivo_ajuste_id, cantidad_entrada, cantidad_salida, costo_unitario, costo_total, saldo_cantidad, saldo_costo_total, lote, serie, fecha_vencimiento, moneda, tipo_cambio, observaciones, fecha_registro, version_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING id]
E           [parameters: [{'empresa_id': 1, 'cantidad_entrada': 10.0, 'costo_unitario': 10.0, 'almacen_id': 1, 'tipo': <TipoMovimiento.COMPRA: 'COMPRA'>, 'producto_id': 1, 'sal ... (210 characters truncated) ... uste_id': None, 'lote': None, 'serie': None, 'observaciones': None, 'proveedor_id': None, 'tipo_documento': None, 'destino_id': None, 'version_id': 1}, {'empresa_id': 1, 'cantidad_entrada': 5.0, 'costo_unitario': 20.0, 'almacen_id': 1, 'tipo': <TipoMovimiento.COMPRA: 'COMPRA'>, 'producto_id': 1, 'sald ... (209 characters truncated) ... uste_id': None, 'lote': None, 'serie': None, 'observaciones': None, 'proveedor_id': None, 'tipo_documento': None, 'destino_id': None, 'version_id': 1}]]

..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\dialects\sqlite\base.py:1287: StatementError
============================== warnings summary ===============================
src\models\database_model.py:12
  C:\Users\TUF\Documents\GitHub\kardex\kardex-valorizado\src\models\database_model.py:12: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

tests/test_inventory_service.py::test_get_valorization_report
  C:\Users\TUF\Documents\GitHub\kardex\kardex-valorizado\tests\conftest.py:30: SAWarning: transaction already deassociated from connection
    transaction.rollback()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_inventory_service.py::test_get_stock_actual_empty - Attribu...
FAILED tests/test_inventory_service.py::test_get_valorization_report - sqlalc...
======================== 2 failed, 2 warnings in 0.37s ========================
